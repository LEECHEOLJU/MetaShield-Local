# prompts.py - AI ë¶„ì„ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ê´€ë¦¬
"""
MetaShield ë³´ì•ˆ ë¶„ì„ì„ ìœ„í•œ AI í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
"""

class SecurityPrompts:
    """ë³´ì•ˆ ë¶„ì„ ê´€ë ¨ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ í´ë˜ìŠ¤"""
    
    @staticmethod
    def get_security_analysis_prompt(payload: str) -> str:
        """
        ë³´ì•ˆ í˜ì´ë¡œë“œ ë¶„ì„ì„ ìœ„í•œ ë©”ì¸ í”„ë¡¬í”„íŠ¸
        """
        return f"""
ì•„ë˜ì˜ Payloadë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì•„ë˜ ë‚´ìš©ì— ë§ì¶°ë³´ì•ˆ ë¶„ì„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.

Payload:
"{payload}"

ë„ˆëŠ” MSSPì—…ì²´ì— ìˆ™ë ¨ëœ ì‹œë‹ˆì–´ ë³´ì•ˆë¶„ì„ ì „ë¬¸ê°€ì•¼
ë³´ì•ˆ ë¶„ì„ê°€ ì…ì¥ì—ì„œ payloadë¥¼ ë¶„ì„í•˜ì—¬ ê³ ê°ì—ê²Œ ë¶„ì„ ë‚´ì—­ì„ ì œê³µí•´ì¤˜ì•¼ë¼
ë„ˆë¬´ ë”±ë”±í•˜ê²Œ ë§ê³  ì•„ë˜ ë³´ê³ ì„œ í˜•íƒœë¥¼ ì§€ì¼œì„œ ê³ ê°ì´ ë³´ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ ë¶„ì„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì¤˜


<ìœ„í˜‘ë„ íŒë‹¨> : XX% (ë‚®ìŒ/ë³´í†µ/ë†’ìŒ/ì‹¬ê°)

1. [ğŸ›¡ï¸íƒì§€ ì´ë²¤íŠ¸ ë¶„ì„ ìš”ì•½]
   (ê°„ë‹¨í•œ íƒì§€ ì´ë²¤íŠ¸ ë¶„ì„ ë‚´ìš©ì„ ê°„ê²°í•˜ê²Œ ì‘ì„±)

2. [ğŸ”ìƒì„¸ ë¶„ì„] 
   (ì‹¤ì œ ê³µê²© ê¸°ë²•, ê³µê²© íë¦„, ì‚¬ìš©ëœ íˆ´ ë° ê¸°ë²• ë“±ì„ ìƒì„¸íˆ ê¸°ìˆ , ê³µê²© êµ¬ë¬¸ë“± êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±)

3. [âš ï¸ì˜í–¥ ë°›ëŠ” ì œí’ˆ ë° ì¡°ê±´]
   (ê³µê²©ì— ëŒ€í•œ ê´€ë ¨ ì·¨ì•½ì  ì •ë³´ ë° ì˜í–¥ ë°›ëŠ” ì œí’ˆ, ë²„ì „, í™˜ê²½ ë“±ì„ ëª…í™•íˆ ê¸°ìˆ )

4. [ğŸ•µï¸ëŒ€ì‘ ë°©ì•ˆ]
   (ê³ ê°ì‚¬ ê´€ì ì—ì„œ ì‹¤ë¬´ì— ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ëŒ€ì‘ ë°©ì•ˆê³¼ ê¶Œê³ ì‚¬í•­ì„ ì‘ì„±)

5. [ğŸš¨ì¶”ê°€ íƒì§€ ë‚´ì—­ / í‰íŒ ì¡°íšŒ]
   (ì¶”ê°€ ì°¸ê³ í•  ë§Œí•œ íƒì§€ ë‚´ì—­ì´ë‚˜ í‰íŒ ì¡°íšŒ ê²°ê³¼ê°€ ìˆë‹¤ë©´ ì‘ì„±, VirusTotal, AbuseIPDB ë“± TIDB ì¡°íšŒ ë‚´ìš© í¬í•¨
    MITRE ATT&CK ê¸°ë²• ë§¤í•‘ì´ ê°€ëŠ¥í•˜ë©´ ë§¤í•‘ ë‚´ìš©ë„ ì‘ì„±)

ìœ„ í˜•ì‹ì—ì„œ [] ì•ˆì˜ ì œëª©ê³¼ ì´ëª¨ì§€ëŠ” ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.

ğŸš¨ ê¸ˆì§€ì‚¬í•­:
- ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• (#, *, -, `, **) ì‚¬ìš© ê¸ˆì§€
- ì œëª© ì´ëª¨ì§€ ë³€ê²½ ê¸ˆì§€  
- ë²ˆí˜¸ ë§¤ê¹€ ë³€ê²½ ê¸ˆì§€

ì ˆëŒ€ ì§€ì¼œì•¼ í•  ê·œì¹™ë“¤:
1. ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ì™„ì „ ê¸ˆì§€: #, *, -, `, ** ë“± íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš© ì ˆëŒ€ ë¶ˆê°€
2. ìœ„ì˜ 1-5ë²ˆ í˜•ì‹ë§Œ ì‚¬ìš©í•˜ì—¬ ë‹µë³€
3. payloadê°€ ì•„ë‹Œ ì§ˆë¬¸ì€ "ë³´ì•ˆ ë¶„ì„ìš© payloadë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" ë‹µë³€
4. íƒì§€ íŒ¨í„´/ì‹œë‚˜ë¦¬ì˜¤ëª… ì…ë ¥ì‹œ ë³´ì•ˆ ë¶„ì„ê°€ ê´€ì  ë„ì›€ë§ ì œê³µ
5. CVE/ì œí’ˆëª…/ì„œë¹„ìŠ¤ëª… ì…ë ¥ì‹œ í•´ë‹¹ ì·¨ì•½ì  ë¶„ì„ ë³´ê³ ì„œ ì‘ì„±
6. ë³´ì•ˆ ê´€ë ¨ ì§ˆë¬¸ì‹œ ë³´ì•ˆ ì „ë¬¸ê°€ë¡œì„œ ë‹µë³€
7. í”„ë¡œê·¸ë¨ ì •ë³´: ì œì‘ì ì´ì² ì£¼ ì„ ì„, 2025ë…„ 8ì›”, V1.0.0
8. ì´ìŠ¤í„°ì—ê·¸: "ì´ì² ì£¼" ì…ë ¥ì‹œ ì´ë²¤íŠ¸ ë‹¹ì²¨ ì¶•í•˜ ë©”ì‹œì§€
"""

    @staticmethod
    def get_system_message() -> str:
        """ì‹œìŠ¤í…œ ë©”ì‹œì§€ - AI ì—­í•  ì •ì˜"""
        return """ë„ˆëŠ” MSSPì—…ì²´ì˜ ìˆ™ë ¨ëœ ì‹œë‹ˆì–´ ë³´ì•ˆë¶„ì„ ì „ë¬¸ê°€ì•¼.

ğŸš¨ ì ˆëŒ€ì ì¸ ì¶œë ¥ í˜•ì‹ ê·œì¹™ ğŸš¨
- ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì„ ì ˆëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ë§ˆë¼: #, *, -, `, ** ë“± ëª¨ë“  íŠ¹ìˆ˜ë¬¸ì ê¸ˆì§€
- ë°˜ë“œì‹œ ìˆ«ì 1-5ë¡œ ì‹œì‘í•˜ëŠ” í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ë¼
- ì´ëª¨ì§€ëŠ” ê° ì„¹ì…˜ ì œëª©ì—ë§Œ ì‚¬ìš©í•˜ë¼
- ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ ë‚´ìš©ì„ ì‘ì„±í•˜ë¼"""

    @staticmethod
    def get_pattern_analysis_prompt(pattern_name: str, pattern_content: str) -> str:
        """íŒ¨í„´ ë¶„ì„ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸"""
        return f"""
ë³´ì•ˆ íƒì§€ íŒ¨í„´ ë¶„ì„ ìš”ì²­:

íŒ¨í„´ëª…: {pattern_name}
íŒ¨í„´ ë‚´ìš©: {pattern_content}

ğŸš¨ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ì‚¬ìš© ê¸ˆì§€: #, *, -, `, ** ë“± íŠ¹ìˆ˜ë¬¸ì ì ˆëŒ€ ì‚¬ìš© ë¶ˆê°€
ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”.

ìœ„ íŒ¨í„´ì— ëŒ€í•´ ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:
1. íŒ¨í„´ì˜ ëª©ì ê³¼ íƒì§€ ëŒ€ìƒ
2. íŒ¨í„´ì˜ êµ¬ì¡° ë° ë§¤ì¹­ ì¡°ê±´ ë¶„ì„
3. ì˜ˆìƒë˜ëŠ” ê³µê²© ì‹œë‚˜ë¦¬ì˜¤
4. íŒ¨í„´ ê°œì„  ì œì•ˆì‚¬í•­
5. ê´€ë ¨ëœ CVEë‚˜ ë³´ì•ˆ ì´ìŠˆ

ë³´ì•ˆ ë¶„ì„ê°€ ê´€ì ì—ì„œ ì‹¤ë¬´ì— ë„ì›€ì´ ë˜ëŠ” ìƒì„¸í•œ ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.
"""

    @staticmethod
    def get_cve_analysis_prompt(cve_id: str, cve_description: str = "") -> str:
        """CVE ë¶„ì„ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸"""
        base_prompt = f"""
CVE ì·¨ì•½ì  ë¶„ì„ ìš”ì²­:

CVE ID: {cve_id}
"""
        if cve_description:
            base_prompt += f"CVE ì„¤ëª…: {cve_description}\n"
        
        base_prompt += """
ğŸš¨ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ì‚¬ìš© ê¸ˆì§€: #, *, -, `, ** ë“± íŠ¹ìˆ˜ë¬¸ì ì ˆëŒ€ ì‚¬ìš© ë¶ˆê°€
ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”.

ìœ„ CVEì— ëŒ€í•´ ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:
1. ì·¨ì•½ì  ê°œìš” ë° ì˜í–¥ë„
2. ê³µê²© ë²¡í„° ë° ì¡°ê±´  
3. ì˜í–¥ë°›ëŠ” ì œí’ˆ ë° ë²„ì „
4. íƒì§€ ë°©ë²• ë° íŒ¨í„´
5. ì™„í™” ë° ëŒ€ì‘ ë°©ì•ˆ

ì‹¤ë¬´ì§„ì´ ì´í•´í•˜ê¸° ì‰½ë„ë¡ í•œêµ­ì–´ë¡œ ìƒì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”.
"""
        return base_prompt

    @staticmethod
    def get_ioc_extraction_prompt(text: str) -> str:
        """IOC ì¶”ì¶œì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸"""
        return f"""
ë‹¤ìŒ í…ìŠ¤íŠ¸ì—ì„œ IOC(Indicators of Compromise)ë¥¼ ì¶”ì¶œí•˜ê³  ë¶„ì„í•´ì£¼ì„¸ìš”:

í…ìŠ¤íŠ¸:
{text}

ì¶”ì¶œ ë° ë¶„ì„ í•­ëª©:
1. IP ì£¼ì†Œ (ì•…ì„± IP ì—¬ë¶€ í‰ê°€ í¬í•¨)
2. ë„ë©”ì¸/URL (ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë„ë©”ì¸ ë¶„ì„)
3. íŒŒì¼ í•´ì‹œ (MD5, SHA1, SHA256)
4. íŒŒì¼ëª… ë° ê²½ë¡œ
5. ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‚¤
6. ê¸°íƒ€ ë³´ì•ˆ ê´€ë ¨ ì§€í‘œ

ê° IOCì˜ ìœ„í—˜ë„ì™€ ì—°ê´€ì„±ì„ ë¶„ì„í•˜ì—¬ ë³´ê³ í•´ì£¼ì„¸ìš”.
"""

    @staticmethod
    def get_comprehensive_report_prompt(payload: str, ai_analysis: str, ioc_data: dict, threat_intel: str) -> str:
        """ì¢…í•© ë³´ê³ ì„œ ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸"""
        return f"""
ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¢…í•© ë³´ì•ˆ ë¶„ì„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

=== ë¶„ì„ ëŒ€ìƒ í˜ì´ë¡œë“œ ===
{payload}

=== AI ì´ˆê¸° ë¶„ì„ ê²°ê³¼ ===
{ai_analysis}

=== ì¶”ì¶œëœ IOC ë°ì´í„° ===
{ioc_data}

=== ìœ„í˜‘ ì¸í…”ë¦¬ì „ìŠ¤ ì •ë³´ ===
{threat_intel}

ìœ„ ëª¨ë“  ì •ë³´ë¥¼ ì¢…í•©í•˜ì—¬ ë‹¤ìŒ êµ¬ì¡°ë¡œ ìµœì¢… ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

ğŸ“‹ ì¢…í•© ë³´ì•ˆ ë¶„ì„ ë³´ê³ ì„œ

1. ğŸ¯ ìš”ì•½ (Executive Summary)
   - í•µì‹¬ ìœ„í˜‘ ìš”ì•½
   - ìœ„í—˜ë„ í‰ê°€
   - ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš” ì‚¬í•­

2. ğŸ” ìƒì„¸ ê¸°ìˆ  ë¶„ì„
   - ê³µê²© ê¸°ë²• ë¶„ì„
   - IOC ì—°ê´€ì„± ë¶„ì„
   - ìœ„í˜‘ í–‰ìœ„ì í”„ë¡œíŒŒì¼ë§

3. âš ï¸ ì˜í–¥ë„ í‰ê°€
   - ë¹„ì¦ˆë‹ˆìŠ¤ ì˜í–¥ë„
   - ê¸°ìˆ ì  ì˜í–¥ë„
   - í™•ì‚° ê°€ëŠ¥ì„±

4. ğŸ›¡ï¸ ëŒ€ì‘ ë°©ì•ˆ
   - ì¦‰ì‹œ ëŒ€ì‘ ì¡°ì¹˜
   - ì¤‘ì¥ê¸° ë³´ì•ˆ ê°•í™” ë°©ì•ˆ
   - ëª¨ë‹ˆí„°ë§ ê¶Œê³ ì‚¬í•­

5. ğŸ“Š ì²¨ë¶€ ìë£Œ
   - IOC ëª©ë¡
   - ê´€ë ¨ CVE ì •ë³´
   - ì°¸ê³  ìë£Œ ë§í¬

ì‹¤ë¬´ì§„ì´ ë°”ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ë³´ê³ ì„œë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
"""

# í”„ë¡¬í”„íŠ¸ ì„¤ì • ìƒìˆ˜
class PromptConfig:
    """í”„ë¡¬í”„íŠ¸ ê´€ë ¨ ì„¤ì •"""
    TEMPERATURE = 0.3
    MAX_COMPLETION_TOKENS = 1200
    TOP_P = 1.0
    
    # ëª¨ë¸ë³„ ì„¤ì • (í•„ìš”ì‹œ í™•ì¥)
    GPT4_CONFIG = {
        "temperature": 0.3,
        "max_completion_tokens": 1500,
        "top_p": 1.0
    }
    
    GPT35_CONFIG = {
        "temperature": 0.3,
        "max_completion_tokens": 1200,
        "top_p": 1.0
    }

# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
def validate_payload(payload: str) -> tuple[bool, str]:
    """í˜ì´ë¡œë“œ ìœ íš¨ì„± ê²€ì‚¬"""
    if not payload or payload.strip() == "":
        return False, "í˜ì´ë¡œë“œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
    
    if len(payload.strip()) < 5:
        return False, "í˜ì´ë¡œë“œê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ìµœì†Œ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."
    
    return True, "ìœ íš¨í•œ í˜ì´ë¡œë“œì…ë‹ˆë‹¤."

def get_prompt_by_input_type(input_text: str) -> tuple[str, str]:
    """ì…ë ¥ íƒ€ì…ì— ë”°ë¥¸ ì ì ˆí•œ í”„ë¡¬í”„íŠ¸ ì„ íƒ"""
    input_lower = input_text.lower().strip()
    
    # CVE íŒ¨í„´ í™•ì¸
    if input_lower.startswith('cve-') and len(input_lower.split('-')) >= 3:
        return "cve", SecurityPrompts.get_cve_analysis_prompt(input_text)
    
    # ê¸°ë³¸ í˜ì´ë¡œë“œ ë¶„ì„
    return "payload", SecurityPrompts.get_security_analysis_prompt(input_text)

if __name__ == "__main__":
    # í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸
    test_payload = "test payload"
    print("=== í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸ ===")
    print("ë³´ì•ˆ ë¶„ì„ í”„ë¡¬í”„íŠ¸:")
    print(SecurityPrompts.get_security_analysis_prompt(test_payload)[:200] + "...")
    print("\nì‹œìŠ¤í…œ ë©”ì‹œì§€:")
    print(SecurityPrompts.get_system_message())